--Create Database
Create Database Project_2;

--Use Database
Use Project_2;

--Create Table
CREATE TABLE Sales
(UserId INT NOT NULL, Created_Date DATE NOT NULL,
 Product_Id INT,
 FOREIGN KEY (UserId) -- Foreign Keys
 REFERENCES User_Name(userid),
 FOREIGN KEY (Product_Id) 
 REFERENCES Product(Product_Id));

 CREATE TABLE Product 
(Product_Id INT PRIMARY KEY,
Product_Name VARCHAR(100) NOT NULL,
Price INT);

CREATE TABLE User_Name 
(UserId INT PRIMARY KEY,
User_Name VARCHAR(100) NOT NULL);

CREATE TABLE Users 
(UserId INT PRIMARY KEY,Signup_Date DATE NOT NULL,
 FOREIGN KEY (UserId)-- Foreign Keys
 REFERENCES User_Name(UserId));

CREATE TABLE Golduser_Signup 
(UserId INT PRIMARY KEY,
Gold_Signup_Date DATE NOT NULL,
FOREIGN KEY (UserId) -- Foreign Keys
REFERENCES User_Name(UserId));

--Insert Values to the Table
INSERT INTO Sales (userid, created_date, product_id) VALUES
(1, '2017-04-19', 2),
(3, '2019-12-18', 1),
(2, '2020-07-20', 3),
(1, '2019-10-23', 2),
(1, '2018-03-19', 3),
(3, '2016-12-20', 2),
(1, '2016-11-09', 1),
(1, '2016-05-20', 3),
(2, '2017-09-24', 1),
(1, '2017-03-11', 2),
(1, '2016-03-11', 1),
(3, '2016-11-10', 1),
(3, '2017-12-07', 2),
(3, '2016-12-15', 2),
(2, '2017-11-08', 2),
(2, '2018-09-10', 3),
(4, '2019-05-01', 1),
(5, '2018-11-23', 3),
(6, '2017-06-30', 9),
(7, '2018-08-12', 8),
(8, '2019-03-19', 7),
(9, '2017-12-04', 6),
(10, '2018-09-22',2),
(4, '2020-08-17', 1),
(5, '2017-05-12',10),
(6, '2014-01-27',11),
(7, '2014-04-02', 7),
(8, '2020-12-15', 8),
(9, '2017-09-08', 8);

INSERT INTO Product (product_id, product_name, price) VALUES
(1, 'Dal Makani', 160),
(2, 'Shahi Panner', 170),
(3, 'Butter Chicken', 340),
(4, 'Aloo Gobi', 150),
(5, 'Chole Bhature', 100),
(6, 'Fish Curry', 380),
(7, 'Chicken Tikka', 300),
(8, 'Mutton Biryani', 450),
(9, 'Veg Pulao', 200),
(10, 'Mango Lassi', 80),
(11, 'Gulab Jamun', 100);

INSERT INTO User_name VALUES
(1,'Anshul'),
(2,'Rohan'),
(3,'Shreya'),
(4,'Priya'),
(5,'Aryan'),
(6,'Sara'),
(7,'Sahil'),
(8,'Tanvi'),
(9,'Ritika'),
(10,'Gaurav');

INSERT INTO Users VALUES
(1,'2014-09-02'),
(2,'2015-01-15'),
(3,'2014-04-11'),
(4,'2015-11-17'),
(10,'2016-01-02'),
(9,'2016-01-02'),
(7,'2013-04-02'),
(8,'2013-12-15'),
(5,'2015-09-08'),
(6,'2014-07-13');

INSERT INTO Golduser_Signup VALUES
(1, '2017-05-10'),  
(3, '2018-03-22'),  
(4, '2019-07-15'),  
(5, '2018-11-30'),  
(7, '2017-09-18');  

--Display Table
Select * from Sales;
Select * from Product;
Select * from User_Name;
Select * from Users;
Select * from Golduser_Signup;

--Q1. What is the total sales revenue generated by each product? 

Select p.Product_Id, p.Product_Name, SUM(p.Price) as Total_Revenue, 
Count(s.Product_Id) as Oders_Received from Sales as s 
Join Product as p
on
s.Product_Id=p.Product_Id
Group by p.Product_Id, p.Product_Name
ORDER BY total_revenue DESC;

--Butter Chicken gives the highest revenue of 1700
--Mango Lassi gives the lowest revenue of 80/--


--Q2. Which 3 product has the highest sales revenue? 

Select TOP 3 p.Product_Id, p.Product_Name, SUM(p.Price) as Total_Revenue 
from Sales as s 
Join Product as p
on
s.Product_Id=p.Product_Id
Group by p.Product_Id, p.Product_Name
ORDER BY total_revenue DESC;

--Butter Chicken with 1700
--Shahi Paneer with 1360
-- Mutton Biriyani with 1350


--Q3. How many users have signed up for the service and has taken the gold membership?
Select Count(DISTINCT un.UserId) as NumOf_Users_SignedUp,
Count(DISTINCT gu.UserId) as NumOf_Gold_Users from User_Name as un
Full Outer join Golduser_Signup as gu
on
un.UserID=gu.UserId;

-- there are total of 10 users out of which 5 are gold user


--Q4. What is the revenue generated from gold users? 
Select Sum(p.Price) as Tota_Revenue_by_GoldUsers from Sales as s
Join Product as p
on 
s.Product_Id=p.Product_Id
join Golduser_Signup as g
on
s.UserId= g.UserId;

--Revenue generated from Gold_Users is 3830


-- Q5. What is the total revenue generated from gold users?
Select Sum(p.Price) as Tota_Revenue_WithOut_GoldUsers 
from Sales as s
Join Product as p
on 
s.Product_Id=p.Product_Id
Where s.UserId Not in 
(Select UserId from Golduser_Signup);
--Revenue generated WithOut Gold_Users is 3060


--Q6. Which users has been a gold user for the How much of time? 
Select g.UserId, u.User_Name, g.Gold_Signup_Date, DATEDIFF(Year,g.Gold_Signup_Date, Getdate()) 
as years_as_gold_member from Golduser_Signup as g
Join User_Name as u
on
g.UserId=u.UserId
Order by years_as_gold_member desc;

--Anshul and Sahil for 8 years
--Shreya and aryan for  7 years
-- Priya for 6 years


--Q7. What is the most popular product among gold users?
Select Top 1 Count( p.Product_Id) as Most_Ordered_GoldUsers, p.Product_Name from Sales as s
Join Product as p
on 
s.Product_Id=p.Product_Id
join Golduser_Signup as g
on
s.UserId= g.UserId
Group by p.Product_Name
Order by Most_Ordered_GoldUsers desc;

--Most popular product among gold members is Dal Makani


--Q8. What is the total sales revenue generated in each year? 
Select YEAR(s.Created_Date) as Year, Sum(p.Price) as Revenue_Made_In_Year from Sales as s
Left Join Product as p
on
s.Product_Id=p.Product_Id
Group by YEAR(s.Created_Date)
Order by Revenue_Made_In_Year desc;

-- Highest revenue generated in 2017 Rs 1950
--Lowest revenue generated in 2014 Rs 400


--Q9. How has the sales revenue changed over the years? 
WITH YearlySales AS (
    SELECT
        YEAR(s.created_date) AS sales_year,
        SUM(p.price) AS total_revenue
    FROM
        sales s
    JOIN
        product p ON s.product_id = p.product_id
    GROUP BY
        YEAR(s.created_date)
),
LaggedSales AS (
    SELECT
        sales_year,
        total_revenue,
        LAG(total_revenue, 1, 0) OVER (ORDER BY sales_year) AS previous_year_revenue
    FROM
        YearlySales
)
SELECT
    sales_year,
    total_revenue,
    previous_year_revenue,
    (total_revenue - previous_year_revenue) AS revenue_change,
    CASE
        WHEN previous_year_revenue = 0 THEN NULL
        ELSE (total_revenue - previous_year_revenue) * 100.0 / previous_year_revenue
    END AS percentage_change
FROM
    LaggedSales
ORDER BY
    sales_year;

--The strongest growth occurred between 2016 and 2017


--Q10. What is the average Gold-signup compare to just sign up for the users? 
SELECT 
    COUNT(DISTINCT g.UserId) * 100 / COUNT(DISTINCT u.UserId) AS GoldSignup_Percentage,
    COUNT(DISTINCT g.UserId) AS GoldUser_Count,
    COUNT(DISTINCT u.UserId) AS TotalUser_Count
FROM Users u
LEFT JOIN Golduser_Signup g 
    ON u.UserId = g.UserId;

--Their are 50% of Gold users form the Users

--Q11. How many gold members users have order how many numbers of time ? 
Select g.UserId, u.User_Name, 
Count(s.Product_Id) as No_Of_Orders from Sales as s
Join User_Name as u
on 
s.UserId=u.UserId
join Golduser_Signup as g
on
s.UserId= g.UserId
Group by g.UserId, u.User_Name;

--Anshul with hishest orders of 7
--Shreya with second highest orders of 5
--Priya,Sahil and Aryan with 2 orders each

--Q12. What is the total amount each customer spend on Online Food Delivery? 
Select u.UserId, u.User_Name, SUM(p.Price) as Amt_Spend from Sales as s
Join Product as p 
on
s.Product_Id=p.Product_Id
join User_Name as u
on
s.UserId=u.UserId
Group by u.UserId, u.User_Name
Order by Amt_Spend desc;

--Anshul with hishest spend on Online Food Delivery Rs 1510
--Gaurav with least spend on Online Food Delivery Rs 170	


--Q13. What is the frequency of customer visits to the online platform? 
SELECT 
    u.UserId,
    un.User_Name,
    COUNT(s.created_date) AS Visit_Frequency
FROM Sales s
JOIN user_name un 
    ON s.userid = un.userid
JOIN users u
    ON s.userid = u.userid
GROUP BY u.userid, un.user_name
ORDER BY visit_frequency DESC;

--Q14. What was the first order purchase by each customer ? 
With OderingSales as 
(Select  u.UserId, u.User_Name, s.Created_Date 
,Row_Number() Over (Partition by u.UserId Order by s.Created_Date) as Row_Num,
p.Product_Name from Sales as s
Left Join Product as p
on
s.Product_Id=p.Product_Id
Left Join User_Name as u
on
s.userid = u.userid)

Select  os.UserId, os.User_Name, os.Created_Date,
p.Product_Name as First_Order from OderingSales as os
Left Join Product as p
on
os.Product_Name=p.Product_Name
Left Join User_Name as u
on
os.userid = u.userid
Where Row_Num = 1;

--Dal Makani was the first orders of 4 users
--Chicken Tikka was the first order of 2 users

--Q15. What is the most purchase item on the menu and how many times was it purchased by all customers? 
Select Top 1 p.Product_Name, Count(s.Product_Id) as Count_On_Oders from Sales as s
Join Product as p
on
s.Product_Id=p.Product_Id
Group by p.Product_Name
Order by Count_On_Oders Desc;

--Shahi Paneer was the most purchased for 8 times


--Q16. Which item was most popular for each customer ? 
WITH UserProductCounts AS (
    SELECT
        s.userid,
        s.product_id,
        COUNT(*) AS purchase_count
    FROM
        sales s
    GROUP BY
        s.userid, s.product_id
),
RankedUserProducts AS (
    SELECT
        upc.userid,
        upc.product_id,
        upc.purchase_count,
        RANK() OVER(PARTITION BY upc.userid ORDER BY upc.purchase_count DESC) as rk
    FROM
        UserProductCounts upc
)
SELECT
    un.User_Name,
    p.product_name,
    rup.purchase_count
FROM
    RankedUserProducts rup
JOIN
    user_name un ON rup.userid = un.userid
JOIN
    product p ON rup.product_id = p.product_id
WHERE
    rup.rk = 1;


--Q17. Which item was purchase first by the customer after they become a member ? 
WITH GoldMemberSales AS (
    SELECT
        s.userid,
        s.product_id, g.Gold_Signup_Date,
        ROW_NUMBER() OVER(PARTITION BY s.userid ORDER BY s.created_date ASC) as rn
    FROM
        sales s
    JOIN
        Golduser_Signup g ON s.userid = g.userid
    WHERE
        s.created_date >= g.gold_signup_date
)
SELECT
    un.User_Name, gms.Gold_Signup_Date as Order_date,
    p.product_name AS First_Order_after_GoldMember
FROM
    GoldMemberSales gms
JOIN
    user_name un ON gms.userid = un.userid
JOIN
    product p ON gms.product_id = p.product_id
WHERE
    gms.rn = 1;

--Q18.Which item was purchase before the customer become a member ? 
WITH PreGoldSales AS (
    SELECT
        s.userid,
        s.product_id, s.Created_Date,
        ROW_NUMBER() OVER(PARTITION BY s.userid ORDER BY s.created_date DESC) as rn
    FROM
        sales s
    JOIN
        Golduser_Signup g ON s.userid = g.userid
    WHERE
        s.created_date < g.gold_signup_date
)
SELECT
    un.User_Name, pgs.Created_Date as Order_Date,
    p.product_name AS Orders_before_Became_GoldUsers
FROM
    PreGoldSales pgs
JOIN
    user_name un ON pgs.userid = un.userid
JOIN
    product p ON pgs.product_id = p.product_id
WHERE
    pgs.rn = 1;

--Q19. What is the total orders and amount spent for each member before they become a member ? 
SELECT
    un.UserId, un.User_Name,
    COUNT(*) AS Total_Orders_before_GoldUsers,
    SUM(p.price) AS Total_Spent_before_GoldUsers
FROM
    sales s
JOIN
    Golduser_Signup g ON s.userid = g.userid
JOIN
    product p ON s.product_id = p.product_id
JOIN
    user_name un ON s.userid = un.userid
WHERE
    s.created_date < g.gold_signup_date
GROUP BY
    un.User_Name, un.UserId;

/*Q20. Rank all the transactions for each member whenever they are a XYZ gold member 
for every non gold member Transaction marks as na ? */
WITH AllSalesDetails AS (
    SELECT
        s.userid,
        s.created_date,
        p.product_name,
        g.gold_signup_date,
        CASE
            WHEN g.gold_signup_date IS NOT NULL AND s.created_date >= g.gold_signup_date THEN 'Gold Member Sale'
            ELSE 'Non-Gold Sale'
        END AS sale_type
    FROM
        sales s
    JOIN
        product p ON s.product_id = p.product_id
    LEFT JOIN
        Golduser_Signup g ON s.userid = g.userid
)
SELECT
    un.UserId,un.User_Name,
    asd.Created_Date,
    asd.Product_Name,
    CASE
        WHEN asd.sale_type = 'Gold Member Sale'
        THEN CAST(RANK() OVER(PARTITION BY asd.userid, asd.sale_type ORDER BY asd.created_date) AS VARCHAR)
        ELSE 'NA'
    END AS transaction_rank
FROM
    AllSalesDetails asd
JOIN
    user_name un ON asd.userid = un.userid
ORDER BY
    un.User_Name, asd.created_date;

